<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>WeatherVision Pro - Умный прогноз погоды</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <style>
         :root {
            --primary: #6366f1;
            --secondary: #8b5cf6;
            --accent: #a855f7;
            --light: #f8fafc;
            --dark: #1e293b;
            --success: #10b981;
            --warning: #f43f5e;
            --info: #0ea5e9;
            --card-bg: rgba(255, 255, 255, 0.92);
            --text-light: #f8fafc;
            --text-dark: #334155;
            --sun: #fbbf24;
            --rain: #60a5fa;
            --snow: #93c5fd;
            --cloud: #cbd5e1;
            --thunder: #9333ea;
            --gradient-primary: linear-gradient(135deg, #6366f1 0%, #8b5cf6 50%, #a855f7 100%);
            --gradient-sunny: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%);
            --gradient-rainy: linear-gradient(135deg, #3b82f6 0%, #60a5fa 100%);
            --gradient-cloudy: linear-gradient(135deg, #64748b 0%, #94a3b8 100%);
            --gradient-night: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1);
            --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1);
        }
        
        @media (prefers-color-scheme: dark) {
             :root {
                --card-bg: rgba(30, 30, 40, 0.95);
                --text-light: #e0e0ff;
                --text-dark: #e0e0ff;
            }
            body {
                background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%) !important;
            }
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Montserrat', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            color: #1e293b;
            background-attachment: fixed;
            background-size: cover;
            transition: all 1s ease;
        }
        
        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        }
        
        .weather-app {
            width: 100%;
            max-width: 1200px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .weather-container {
            background: var(--card-bg);
            border-radius: 24px;
            box-shadow: var(--shadow-xl);
            width: 100%;
            overflow: hidden;
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            transform: translateY(0);
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            z-index: 10;
            background-image: radial-gradient(at 0% 0%, rgba(99, 102, 241, 0.1) 0px, transparent 50%), radial-gradient(at 100% 100%, rgba(139, 92, 246, 0.1) 0px, transparent 50%);
        }
        
        .weather-container:hover {
            transform: translateY(-8px) scale(1.005);
            box-shadow: var(--shadow-xl), 0 25px 50px -12px rgba(99, 102, 241, 0.25);
        }
        
        header.weather-header {
            background: var(--gradient-primary);
            color: var(--text-light);
            padding: 30px 25px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        
        .weather-header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.15) 0%, rgba(255, 255, 255, 0) 70%);
            animation: pulse 15s infinite linear;
            z-index: 1;
        }
        
        @keyframes pulse {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }
        
        .header-content {
            position: relative;
            z-index: 2;
        }
        
        .weather-title {
            font-size: 32px;
            font-weight: 800;
            margin-bottom: 8px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            letter-spacing: -0.5px;
        }
        
        .weather-subtitle {
            font-size: 15px;
            opacity: 0.9;
            font-weight: 400;
            letter-spacing: 0.3px;
        }
        
        .search-container {
            display: flex;
            margin-top: 20px;
            position: relative;
            z-index: 2;
        }
        
        .search-input {
            flex: 1;
            padding: 18px 24px;
            border: none;
            border-radius: 30px 0 0 30px;
            font-size: 16px;
            outline: none;
            background: rgba(255, 255, 255, 0.95);
            box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
            font-weight: 500;
            color: #1e293b;
            backdrop-filter: blur(10px);
        }
        
        .search-input:focus {
            background: white;
            box-shadow: inset 0 2px 12px rgba(0, 0, 0, 0.12), 0 0 0 3px rgba(99, 102, 241, 0.2);
        }
        
        .search-button {
            background-color: var(--accent);
            color: white;
            border: none;
            padding: 0 30px;
            border-radius: 0 30px 30px 0;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: var(--shadow);
            font-weight: 600;
        }
        
        .search-button:hover {
            background-color: var(--secondary);
            transform: translateY(-2px) scale(1.05);
            box-shadow: var(--shadow-lg);
        }
        
        .location-button {
            background-color: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            border-radius: 30px;
            padding: 0 15px;
            margin-left: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(5px);
        }
        
        .location-button:hover {
            background-color: rgba(255, 255, 255, 0.3);
        }
        
        main.weather-content {
            padding: 30px;
            position: relative;
        }
        
        .current-weather {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 30px;
            position: relative;
        }
        
        .location-info {
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .location {
            font-size: 24px;
            font-weight: 600;
            display: flex;
            align-items: center;
            color: var(--text-dark);
        }
        
        .location svg {
            margin-right: 8px;
            color: var(--primary);
        }
        
        .favorite-btn {
            background: none;
            border: none;
            cursor: pointer;
            color: #ccc;
            font-size: 24px;
            transition: all 0.3s ease;
        }
        
        .favorite-btn.active {
            color: var(--warning);
        }
        
        .date-time {
            font-size: 14px;
            color: #bbb;
            margin-bottom: 20px;
            width: 100%;
            text-align: left;
        }
        
        .weather-main {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
            margin-bottom: 20px;
        }
        
        .weather-icon-container {
            position: relative;
            width: 160px;
            height: 160px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 20px;
        }
        
        .weather-icon-bg {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.15) 0%, rgba(139, 92, 246, 0.05) 100%);
            animation: pulseScale 3s infinite ease-in-out;
            box-shadow: inset 0 0 40px rgba(99, 102, 241, 0.1), 0 10px 30px rgba(99, 102, 241, 0.2);
        }
        
        @keyframes pulseScale {
            0%,
            100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.05);
            }
        }
        
        .weather-icon {
            width: 130px;
            height: 130px;
            z-index: 1;
            filter: drop-shadow(0 8px 20px rgba(0, 0, 0, 0.2));
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            animation: float 3s infinite ease-in-out;
        }
        
        @keyframes float {
            0%,
            100% {
                transform: translateY(0) rotate(0deg);
            }
            50% {
                transform: translateY(-10px) rotate(5deg);
            }
        }
        
        .weather-icon:hover {
            transform: scale(1.15) rotate(10deg);
            filter: drop-shadow(0 12px 25px rgba(0, 0, 0, 0.3));
        }
        
        .temperature-container {
            text-align: right;
            flex: 1;
            display: flex;
            align-items: baseline;
            justify-content: flex-end;
            gap: 2px;
        }
        
        .temperature {
            font-size: 84px;
            font-weight: 800;
            margin-bottom: 8px;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            position: relative;
            display: inline-block;
            text-shadow: 0 2px 10px rgba(99, 102, 241, 0.2);
            line-height: 1;
        }
        
        .temperature-unit {
            font-size: 42px;
            position: static;
            margin-left: -1px;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: 600;
            align-self: flex-start;
            margin-top: 0.3em;
        }
        
        .description {
            font-size: 22px;
            color: var(--text-dark);
            margin-bottom: 15px;
            text-transform: capitalize;
            font-weight: 600;
            letter-spacing: 0.3px;
            background: linear-gradient(135deg, #475569 0%, #64748b 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: #fff;
        }
        
        .details {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            width: 100%;
            margin-top: 30px;
        }
        
        .detail-item {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 20px;
            padding: 20px 15px;
            text-align: center;
            box-shadow: var(--shadow);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.4);
            position: relative;
            overflow: hidden;
        }
        
        .detail-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--gradient-primary);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .detail-item:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: var(--shadow-xl);
            background: rgba(255, 255, 255, 0.95);
        }
        
        .detail-item:hover::before {
            opacity: 1;
        }
        
        .detail-icon {
            font-size: 32px;
            margin-bottom: 12px;
            color: var(--primary);
            display: flex;
            justify-content: center;
            align-items: center;
            height: 48px;
        }
        
        .detail-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 6px;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .detail-label {
            font-size: 14px;
            color: #64748b;
            font-weight: 500;
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }
        
        .forecast {
            margin-top: 30px;
        }
        
        .section-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
            color: #1e293b;
            display: flex;
            align-items: center;
        }
        
        .section-title-under {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
            color: #fff;
            display: flex;
            align-items: center;
        }
        
        .section-title svg {
            margin-right: 10px;
            color: var(--primary);
        }
        
        .forecast-items {
            display: flex;
            overflow-x: auto;
            gap: 15px;
            padding-bottom: 15px;
            scrollbar-width: thin;
            scrollbar-color: var(--primary) rgba(0, 0, 0, 0.1);
        }
        
        .forecast-items::-webkit-scrollbar {
            height: 6px;
        }
        
        .forecast-items::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.1);
            border-radius: 10px;
        }
        
        .forecast-items::-webkit-scrollbar-thumb {
            background-color: var(--primary);
            border-radius: 10px;
        }
        
        .forecast-item {
            min-width: 140px;
            text-align: center;
            padding: 20px 15px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 20px;
            box-shadow: var(--shadow);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            flex-shrink: 0;
            cursor: pointer;
            position: relative;
        }
        
        .forecast-item::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 3px;
            background: var(--gradient-primary);
            transition: width 0.3s ease;
            border-radius: 3px;
        }
        
        .forecast-item.active {
            background: rgba(99, 102, 241, 0.15);
            border: 1px solid rgba(99, 102, 241, 0.3);
            box-shadow: 0 8px 25px rgba(99, 102, 241, 0.15);
        }
        
        .forecast-item.active::after {
            width: 60%;
        }
        
        .forecast-item:hover {
            transform: translateY(-8px) scale(1.05);
            box-shadow: var(--shadow-xl);
            background: rgba(255, 255, 255, 0.95);
        }
        
        .forecast-item:hover::after {
            width: 80%;
        }
        
        .forecast-day {
            font-weight: 600;
            margin-bottom: 10px;
            color: #000000;
        }
        
        .forecast-date {
            font-size: 12px;
            color: #aaa;
            margin-bottom: 10px;
        }
        
        .forecast-icon {
            width: 60px;
            height: 60px;
            margin: 8px auto;
            filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.15));
        }
        
        .forecast-temp {
            font-weight: 600;
            color: var(--primary);
            display: flex;
            justify-content: center;
            gap: 5px;
        }
        
        .forecast-temp-max {
            color: var(--warning);
        }
        
        .hourly-forecast {
            margin-top: 30px;
        }
        
        .hourly-items {
            display: flex;
            overflow-x: auto;
            gap: 10px;
            padding-bottom: 15px;
        }
        
        .hourly-item {
            min-width: 100px;
            text-align: center;
            padding: 18px 12px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 20px;
            box-shadow: var(--shadow);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            flex-shrink: 0;
            position: relative;
        }
        
        .hourly-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border-radius: 20px;
            padding: 2px;
            background: linear-gradient(45deg, transparent, rgba(99, 102, 241, 0.3), transparent);
            -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            -webkit-mask-composite: xor;
            mask-composite: exclude;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .hourly-item:hover {
            transform: translateY(-6px) scale(1.05);
            box-shadow: var(--shadow-lg);
            background: rgba(255, 255, 255, 0.95);
        }
        
        .hourly-item:hover::before {
            opacity: 1;
        }
        
        .hourly-time {
            font-weight: 600;
            margin-bottom: 10px;
            color: #000000;
            font-size: 14px;
        }
        
        .hourly-icon {
            width: 48px;
            height: 48px;
            margin: 8px auto;
            filter: drop-shadow(0 3px 6px rgba(0, 0, 0, 0.15));
        }
        
        .hourly-temp {
            font-weight: 600;
            color: var(--primary);
            font-size: 16px;
        }
        
        .loading {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-dark);
            font-size: 18px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(99, 102, 241, 0.1);
            border-top-color: var(--primary);
            border-right-color: var(--secondary);
            border-bottom-color: var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
            box-shadow: 0 0 20px rgba(99, 102, 241, 0.3);
        }
        
        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
        
        .error-message {
            color: var(--warning);
            text-align: center;
            margin-top: 15px;
            font-weight: 500;
            background: rgba(255, 255, 255, 0.8);
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            animation: shake 0.5s ease;
        }
        
        @keyframes shake {
            0%,
            100% {
                transform: translateX(0);
            }
            20%,
            60% {
                transform: translateX(-5px);
            }
            40%,
            80% {
                transform: translateX(5px);
            }
        }
        
        .weather-background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            opacity: 0.3;
        }
        
        .additional-info {
            margin-top: 30px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .info-card {
            background: rgba(255, 255, 255, 0.8);
            border-radius: 20px;
            padding: 20px;
            box-shadow: var(--shadow);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            position: relative;
            overflow: hidden;
        }
        
        .info-card::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(99, 102, 241, 0.1) 0%, transparent 70%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .info-card:hover {
            transform: translateY(-6px);
            box-shadow: var(--shadow-xl);
            background: rgba(255, 255, 255, 0.95);
        }
        
        .info-card:hover::before {
            opacity: 1;
        }
        
        .info-card-title {
            font-size: 14px;
            color: #000000;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
        }
        
        .info-card-title svg {
            margin-right: 8px;
            color: var(--primary);
        }
        
        .info-card-value {
            font-size: 20px;
            font-weight: 700;
            color: var(--text-dark);
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .sun-times {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
        }
        
        .sun-time {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .sun-icon {
            font-size: 20px;
            margin-bottom: 5px;
        }
        
        .sunrise-icon {
            color: #ff9e00;
        }
        
        .sunset-icon {
            color: #ff6b00;
        }
        
        .sun-time-label {
            font-size: 12px;
            color: #000000;
        }
        
        .sun-time-value {
            font-size: 14px;
            font-weight: 500;
        }
        
        .favorites-panel {
            margin-top: 20px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.7);
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        .favorites-list {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
            margin-top: 10px;
        }
        
        .favorite-city {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            padding: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            border: 1px solid rgba(0, 0, 0, 0.1);
        }
        
        .favorite-city:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
        }
        
        .favorite-city-info {
            display: flex;
            flex-direction: column;
        }
        
        .favorite-city-name {
            font-weight: 600;
            font-size: 16px;
            color: var(--text-dark);
        }
        
        .favorite-city-time {
            font-size: 14px;
            color: #aaa;
            margin-top: 5px;
        }
        
        .favorite-city-weather {
            display: flex;
            align-items: center;
        }
        
        .favorite-city-temp {
            font-size: 20px;
            font-weight: 600;
            color: var(--primary);
            margin-right: 10px;
        }
        
        .favorite-city-icon {
            width: 40px;
            height: 40px;
        }
        
        .favorite-city .remove-btn {
            margin-left: 15px;
            color: #ff6b6b;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 20px;
            padding: 5px;
        }
        
        .air-quality {
            margin-top: 15px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.7);
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        .air-quality-index {
            font-size: 24px;
            font-weight: 700;
            margin: 10px 0;
            display: flex;
            align-items: center;
        }
        
        .air-quality-level {
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            margin-left: 10px;
        }
        
        .air-quality-good {
            background-color: #4CAF50;
            color: white;
        }
        
        .air-quality-moderate {
            background-color: #FFEB3B;
            color: #333;
        }
        
        .air-quality-unhealthy {
            background-color: #FF9800;
            color: white;
        }
        
        .air-quality-very-unhealthy {
            background-color: #F44336;
            color: white;
        }
        
        .air-quality-hazardous {
            background-color: #673AB7;
            color: white;
        }
        
        .air-quality-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
        }
        
        .air-quality-item {
            font-size: 14px;
        }
        
        .air-quality-item span {
            font-weight: 600;
            color: var(--primary);
        }
        
        .map-container {
            height: 200px;
            margin-top: 20px;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        #map {
            height: 100%;
            width: 100%;
            border-radius: 15px;
        }
        
        .units-switcher {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 15px;
        }
        
        .unit-btn {
            background: rgba(67, 97, 238, 0.1);
            border: none;
            padding: 5px 15px;
            border-radius: 20px;
            margin-left: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }
        
        .unit-btn.active {
            background: var(--primary);
            color: white;
        }
        
        .tabs {
            display: flex;
            border-bottom: 1px solid rgba(203, 213, 225, 0.3);
            margin-bottom: 30px;
            gap: 10px;
        }
        
        .tab {
            padding: 14px 24px;
            cursor: pointer;
            font-weight: 600;
            color: #94a3b8;
            border-bottom: 3px solid transparent;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 12px 12px 0 0;
            position: relative;
            overflow: hidden;
        }
        
        .tab::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--gradient-primary);
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: -1;
        }
        
        .tab.active {
            color: white;
            background: var(--gradient-primary);
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
        }
        
        .tab:not(.active):hover {
            color: var(--primary);
            background: rgba(99, 102, 241, 0.1);
            transform: translateY(-2px);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        /* Анимации для разных погодных условий */
        
        .animate-rain,
        .animate-snow,
        .animate-clouds,
        .animate-sun,
        .animate-thunder {
            position: relative;
            overflow: hidden;
        }
        
        .animate-rain::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" opacity="0.1"><path d="M20,5 L20,15 M30,5 L30,20 M40,5 L40,25 M50,5 L50,15 M60,5 L60,20 M70,5 L70,25 M80,5 L80,15" stroke="%234361ee" stroke-width="2"/></svg>');
            animation: rain 1s linear infinite;
            pointer-events: none;
        }
        
        @keyframes rain {
            0% {
                transform: translateY(-100%);
            }
            100% {
                transform: translateY(100%);
            }
        }
        
        .animate-snow::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" opacity="0.1"><circle cx="10" cy="10" r="1.5" fill="%23ffffff"/><circle cx="25" cy="25" r="1" fill="%23ffffff"/><circle cx="40" cy="5" r="1.2" fill="%23ffffff"/><circle cx="60" cy="15" r="1" fill="%23ffffff"/><circle cx="75" cy="30" r="1.5" fill="%23ffffff"/><circle cx="90" cy="10" r="1.2" fill="%23ffffff"/></svg>');
            animation: snow 10s linear infinite;
            pointer-events: none;
        }
        
        @keyframes snow {
            0% {
                transform: translateY(-100%) rotate(0deg);
            }
            100% {
                transform: translateY(100%) rotate(360deg);
            }
        }
        
        .animate-clouds::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 200%;
            height: 100%;
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 50" opacity="0.05"><path d="M20,25 Q25,15 35,20 Q40,5 55,10 Q70,5 75,20 Q85,15 90,25 Q85,35 75,30 Q70,45 55,40 Q40,45 35,30 Q25,35 20,25" fill="%234361ee"/></svg>');
            animation: clouds 30s linear infinite;
            pointer-events: none;
        }
        
        @keyframes clouds {
            0% {
                transform: translateX(0) scale(1);
            }
            50% {
                transform: translateX(-50%) scale(1.05);
            }
            100% {
                transform: translateX(-100%) scale(1);
            }
        }
        
        .animate-sun::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(255, 200, 0, 0.05) 0%, rgba(255, 200, 0, 0) 70%);
            animation: sunPulse 4s infinite alternate;
            pointer-events: none;
        }
        
        @keyframes sunPulse {
            0% {
                transform: scale(1);
                opacity: 0.1;
            }
            50% {
                transform: scale(1.2);
                opacity: 0.2;
            }
            100% {
                transform: scale(1);
                opacity: 0.1;
            }
        }
        
        .animate-thunder::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(148, 0, 211, 0.05) 0%, rgba(148, 0, 211, 0) 70%);
            animation: thunderFlash 8s infinite;
            pointer-events: none;
        }
        
        @keyframes thunderFlash {
            0%,
            90%,
            93%,
            96%,
            100% {
                opacity: 0;
            }
            91%,
            92%,
            94%,
            95% {
                opacity: 0.3;
            }
        }
        
        @keyframes shimmer {
            0% {
                background-position: -1000px 0;
            }
            100% {
                background-position: 1000px 0;
            }
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-30px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        .weather-content>* {
            animation: fadeIn 0.6s ease-out forwards;
        }
        
        .weather-content>*:nth-child(1) {
            animation-delay: 0.1s;
        }
        
        .weather-content>*:nth-child(2) {
            animation-delay: 0.2s;
        }
        
        .weather-content>*:nth-child(3) {
            animation-delay: 0.3s;
        }
        
        .weather-content>*:nth-child(4) {
            animation-delay: 0.4s;
        }
        
        .weather-content>*:nth-child(5) {
            animation-delay: 0.5s;
        }
        
        @media (prefers-reduced-motion: reduce) {
            .animate-rain::after,
            .animate-snow::after,
            .animate-clouds::after,
            .animate-sun::after,
            .animate-thunder::after,
            .weather-icon-bg,
            .weather-icon,
            .weather-container,
            .detail-item,
            .forecast-item,
            .hourly-item,
            .info-card,
            .favorite-city {
                animation: none !important;
                transition: none !important;
                transform: none !important;
            }
        }
        /* Адаптивные стили */
        
        @media (max-width: 1024px) {
            .weather-app {
                max-width: 800px;
            }
            .details {
                grid-template-columns: repeat(2, 1fr);
            }
            .additional-info {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 768px) {
            .weather-main {
                flex-direction: column;
                align-items: flex-start;
            }
            .temperature-container {
                text-align: left;
                width: 100%;
                margin-top: 15px;
            }
            .temperature {
                font-size: 60px;
            }
            .favorites-list {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 600px) {
            .weather-header {
                padding: 20px 15px;
            }
            .weather-title {
                font-size: 24px;
            }
            .weather-content {
                padding: 20px 15px;
            }
            .temperature {
                font-size: 48px;
            }
            .details {
                grid-template-columns: 1fr;
            }
            .forecast-item,
            .hourly-item {
                min-width: 100px;
                padding: 12px;
            }
            .air-quality-details {
                grid-template-columns: 1fr;
            }
            .favorite-city {
                flex-direction: column;
                align-items: flex-start;
            }
            .favorite-city-weather {
                width: 100%;
                justify-content: space-between;
                margin-top: 10px;
            }
            .remove-btn {
                align-self: flex-end;
            }
        }
        
        @media (max-width: 480px) {
            .search-container {
                flex-direction: column;
            }
            .search-input {
                border-radius: 30px;
                margin-bottom: 10px;
            }
            .search-button {
                border-radius: 30px;
                padding: 12px;
            }
            .location-button {
                margin-left: 0;
                margin-top: 10px;
                padding: 12px;
            }
            .forecast-item,
            .hourly-item {
                min-width: 80px;
            }
        }
        
        .forecast-items::-webkit-scrollbar,
        .hourly-items::-webkit-scrollbar {
            height: 8px;
        }
        
        .forecast-items::-webkit-scrollbar-track,
        .hourly-items::-webkit-scrollbar-track {
            background: rgba(203, 213, 225, 0.2);
            border-radius: 10px;
        }
        
        .forecast-items::-webkit-scrollbar-thumb,
        .hourly-items::-webkit-scrollbar-thumb {
            background: var(--gradient-primary);
            border-radius: 10px;
            transition: all 0.3s ease;
        }
        
        .forecast-items::-webkit-scrollbar-thumb:hover,
        .hourly-items::-webkit-scrollbar-thumb:hover {
            background: var(--gradient-primary);
            transform: scale(1.1);
        }
    </style>
</head>

<body>
    <div class="weather-app">
        <div class="weather-container" id="weather-container">
            <header class="weather-header">
                <div class="header-content">
                    <h1 class="weather-title">WeatherVision Pro</h1>
                    <p class="weather-subtitle">Умный прогноз погоды с точностью до минуты</p>
                    <div class="search-container">
                        <input type="text" class="search-input" placeholder="Введите город..." id="city-input" />
                        <button class="search-button" id="search-button">
                            <span class="material-symbols-outlined">search</span>
                        </button>
                        <button class="location-button" id="location-button" title="Мое местоположение">
                            <span class="material-symbols-outlined">my_location</span>
                        </button>
                    </div>
                    <div id="error-message" class="error-message"></div>
                </div>
            </header>
            <main class="weather-content">
                <div class="tabs">
                    <div class="tab active" data-tab="current">Текущая погода</div>
                    <div class="tab" data-tab="favorites">Избранное</div>
                </div>
                <div class="tab-content active" id="current-tab">
                    <div class="units-switcher">
                        <button class="unit-btn active" data-unit="metric">°C, м/с</button>
                        <button class="unit-btn" data-unit="imperial">°F, миль/ч</button>
                    </div>
                    <div id="current-weather" class="current-weather">
                        <div class="loading">
                            <div class="loading-spinner"></div>
                            Определяем ваше местоположение...
                        </div>
                    </div>
                    <div class="additional-info" id="additional-info"></div>
                    <div id="air-quality" class="air-quality" style="display: none;"></div>
                    <div id="hourly-forecast" class="hourly-forecast" style="display: none;">
                        <h3 class="section-title-under">
                            <span class="material-symbols-outlined">schedule</span> Почасовой прогноз
                        </h3>
                        <div id="hourly-items" class="hourly-items"></div>
                    </div>
                    <div class="forecast">
                        <h3 class="section-title-under">
                            <span class="material-symbols-outlined">calendar_month</span> Прогноз на 5 дней
                        </h3>
                        <div id="forecast-items" class="forecast-items"></div>
                    </div>
                    <div id="map-container" class="map-container" style="display: none;">
                        <div id="map"></div>
                    </div>
                </div>
                <div class="tab-content" id="favorites-tab">
                    <div class="favorites-panel">
                        <h3 class="section-title">
                            <span class="material-symbols-outlined">favorite</span> Избранные города
                        </h3>
                        <div id="favorites-list" class="favorites-list">
                            <!-- Статический виджет погоды для Москвы -->
                            <div class="favorite-city-widget" style="
                        background: rgba(255, 255, 255, 0.95);
                        border-radius: 20px;
                        padding: 25px;
                        box-shadow: var(--shadow);
                        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
                        backdrop-filter: blur(10px);
                        border: 1px solid rgba(255, 255, 255, 0.4);
                        color: #1e293b;
                        max-width: 350px;
                        margin: 0 auto;
                    ">
                                <div style="
                            display: flex;
                            justify-content: space-between;
                            align-items: flex-start;
                            margin-bottom: 15px;
                        ">
                                    <div>
                                        <div style="
                                    font-size: 16px;
                                    font-weight: 600;
                                    color: #6366f1;
                                    margin-bottom: 5px;
                                ">
                                            Текущая погода
                                        </div>
                                        <div style="
                                    font-size: 12px;
                                    color: #64748b;
                                ">
                                            Избранное
                                        </div>
                                    </div>
                                    <button class="favorite-btn active" style="
                                background: none;
                                border: none;
                                cursor: pointer;
                                color: #f43f5e;
                                font-size: 24px;
                                padding: 0;
                            ">
                                <span class="material-symbols-outlined">favorite</span>
                            </button>
                                </div>

                                <div style="
                            font-size: 12px;
                            color: #64748b;
                            margin-bottom: 25px;
                            padding-bottom: 15px;
                            border-bottom: 1px solid rgba(203, 213, 225, 0.3);
                        ">
                                    © Москва, RU<br> воскресенье, 21 декабря 2025 г. в 21:59
                                </div>

                                <div style="
                            display: flex;
                            align-items: center;
                            justify-content: space-between;
                            margin-bottom: 20px;
                        ">
                                    <div style="
                                font-size: 64px;
                                font-weight: 800;
                                background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
                                -webkit-background-clip: text;
                                background-clip: text;
                                -webkit-text-fill-color: transparent;
                                line-height: 1;
                            ">
                                        -3<span style="font-size: 32px; margin-left: -10px;">°C</span>
                                    </div>
                                    <div style="
                                width: 80px;
                                height: 80px;
                                background: linear-gradient(135deg, rgba(99, 102, 241, 0.15) 0%, rgba(139, 92, 246, 0.05) 100%);
                                border-radius: 50%;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                            ">
                                        <span class="material-symbols-outlined" style="
                                    font-size: 48px;
                                    background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
                                    -webkit-background-clip: text;
                                    background-clip: text;
                                    -webkit-text-fill-color: transparent;
                                ">
                                    ac_unit
                                </span>
                                    </div>
                                </div>

                                <div style="
                            font-size: 14px;
                            color: #64748b;
                            text-align: center;
                            margin-bottom: 30px;
                            text-transform: uppercase;
                            letter-spacing: 1px;
                            font-weight: 500;
                        ">
                                    Ощущается как -5°C
                                </div>

                                <div style="
                            display: grid;
                            grid-template-columns: 1fr 1fr;
                            gap: 20px;
                            margin-top: 20px;
                        ">
                                    <div style="
                                background: rgba(99, 102, 241, 0.08);
                                border-radius: 15px;
                                padding: 15px;
                                text-align: center;
                            ">
                                        <div style="
                                    font-size: 12px;
                                    color: #64748b;
                                    margin-bottom: 8px;
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    gap: 5px;
                                ">
                                            <span class="material-symbols-outlined" style="font-size: 16px;">humidity_percentage</span> ВЛАЖНОСТЬ
                                        </div>
                                        <div style="
                                    font-size: 24px;
                                    font-weight: 700;
                                    background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
                                    -webkit-background-clip: text;
                                    background-clip: text;
                                    -webkit-text-fill-color: transparent;
                                ">
                                            72%
                                        </div>
                                    </div>

                                    <div style="
                                background: rgba(99, 102, 241, 0.08);
                                border-radius: 15px;
                                padding: 15px;
                                text-align: center;
                            ">
                                        <div style="
                                    font-size: 12px;
                                    color: #64748b;
                                    margin-bottom: 8px;
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    gap: 5px;
                                ">
                                            <span class="material-symbols-outlined" style="font-size: 16px;">air</span> ВЕТЕР
                                        </div>
                                        <div style="
                                    font-size: 24px;
                                    font-weight: 700;
                                    background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
                                    -webkit-background-clip: text;
                                    background-clip: text;
                                    -webkit-text-fill-color: transparent;
                                ">
                                            3 м/с
                                        </div>
                                    </div>
                                </div>

                                <div style="
                            margin-top: 25px;
                            padding-top: 20px;
                            border-top: 1px solid rgba(203, 213, 225, 0.3);
                        ">
                                    <div style="
                                font-size: 12px;
                                color: #64748b;
                                margin-bottom: 10px;
                            ">
                                        Добавлен в избранное: 21.12.2025
                                    </div>
                                    <button style="
                                width: 100%;
                                background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
                                color: white;
                                border: none;
                                padding: 12px;
                                border-radius: 12px;
                                cursor: pointer;
                                font-weight: 600;
                                font-size: 14px;
                                transition: all 0.3s ease;
                                " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 25px rgba(99, 102, 241, 0.3)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                                Обновить данные
                            </button>
                                </div>
                            </div>
                            <!-- Конец статического виджета -->

                            <!-- Динамический список избранных городов будет загружаться сюда -->
                            <div id="dynamic-favorites-list" style="display: none;"></div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const apiKey = 'e7704bc895b4a8d2dfd4a29d404285b6';
            const cityInput = document.getElementById('city-input');
            const searchButton = document.getElementById('search-button');
            const locationButton = document.getElementById('location-button');
            const currentWeatherDiv = document.getElementById('current-weather');
            const forecastItemsDiv = document.getElementById('forecast-items');
            const hourlyItemsDiv = document.getElementById('hourly-items');
            const errorMessageDiv = document.getElementById('error-message');
            const additionalInfoDiv = document.getElementById('additional-info');
            const airQualityDiv = document.getElementById('air-quality');
            const hourlyForecastDiv = document.getElementById('hourly-forecast');
            const mapContainerDiv = document.getElementById('map-container');
            const mapDiv = document.getElementById('map');
            const favoritesListDiv = document.getElementById('favorites-list');
            const weatherContainer = document.getElementById('weather-container');
            const body = document.body;
            const unitButtons = document.querySelectorAll('.unit-btn');
            const tabs = document.querySelectorAll('.tab');
            const tabContents = document.querySelectorAll('.tab-content');
            let currentUnit = 'metric';
            let currentLocation = null;
            let map = null;
            let marker = null;
            let mapInitialized = false;
            let favorites;
            try {
                favorites = JSON.parse(localStorage.getItem('weatherFavorites')) || [];
            } catch (error) {
                console.error('Ошибка при чтении из localStorage:', error);
                favorites = [];
            }
            let selectedForecastDay = 0;

            initApp();

            function initApp() {
                setupEventListeners();
                detectLocation();
            }

            function setupEventListeners() {
                searchButton.addEventListener('click', () => {
                    const city = cityInput.value.trim();
                    if (city) fetchWeather(city);
                });

                cityInput.addEventListener('keypress', e => {
                    if (e.key === 'Enter') {
                        const city = cityInput.value.trim();
                        if (city) fetchWeather(city);
                    }
                });

                locationButton.addEventListener('click', detectLocation);

                unitButtons.forEach(btn => {
                    btn.addEventListener('click', function() {
                        unitButtons.forEach(b => b.classList.remove('active'));
                        this.classList.add('active');
                        currentUnit = this.dataset.unit;
                        if (currentLocation) {
                            showLoading('Применяем настройки...');
                            fetchWeather(currentLocation);
                        }
                    });
                });

                tabs.forEach(tab => {
                    tab.addEventListener('click', function() {
                        tabs.forEach(t => t.classList.remove('active'));
                        this.classList.add('active');
                        const tabId = this.dataset.tab;
                        tabContents.forEach(content => content.classList.remove('active'));
                        document.getElementById(`${tabId}-tab`).classList.add('active');
                        if (tabId === 'favorites') updateFavoritesWeather();
                    });
                });
            }

            function detectLocation() {
                if (!navigator.geolocation) {
                    showError('Геолокация не поддерживается вашим браузером');
                    fetchWeather('Москва');
                    return;
                }
                showLoading('Определяем ваше местоположение...');
                navigator.geolocation.getCurrentPosition(
                    pos => fetchWeatherByCoords(pos.coords.latitude, pos.coords.longitude),
                    err => {
                        console.error('Geolocation error:', err);
                        showError('Не удалось определить местоположение. Показываем погоду для Москвы');
                        fetchWeather('Москва');
                    }, {
                        enableHighAccuracy: true,
                        timeout: 10000
                    }
                );
            }

            function fetchWeather(location) {
                hideError();
                showLoading('Загрузка данных о погоде...');
                resetSections();

                currentLocation = location;
                cityInput.value = location;

                fetch(`https://api.openweathermap.org/data/2.5/weather?q=${encodeURIComponent(location)}&units=${currentUnit}&appid=${apiKey}&lang=ru`)
                    .then(checkResponse)
                    .then(data => {
                        displayCurrentWeather(data);
                        fetchAirQuality(data.coord.lat, data.coord.lon);
                        fetchHourlyForecast(data.coord.lat, data.coord.lon);
                        initMap(data.coord.lat, data.coord.lon, data.name);
                        return fetch(`https://api.openweathermap.org/data/2.5/forecast?q=${encodeURIComponent(location)}&units=${currentUnit}&appid=${apiKey}&lang=ru`);
                    })
                    .then(checkResponse)
                    .then(displayForecast)
                    .catch(handleFetchError);
            }

            function fetchWeatherByCoords(lat, lon) {
                hideError();
                showLoading('Загрузка данных о погоде...');
                resetSections();

                fetch(`https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&units=${currentUnit}&appid=${apiKey}&lang=ru`)
                    .then(checkResponse)
                    .then(data => {
                        displayCurrentWeather(data);
                        fetchAirQuality(lat, lon);
                        fetchHourlyForecast(lat, lon);
                        initMap(lat, lon, data.name);
                        currentLocation = data.name;
                        cityInput.value = data.name;
                        return fetch(`https://api.openweathermap.org/data/2.5/forecast?lat=${lat}&lon=${lon}&units=${currentUnit}&appid=${apiKey}&lang=ru`);
                    })
                    .then(checkResponse)
                    .then(displayForecast)
                    .catch(handleFetchError);
            }

            function checkResponse(response) {
                if (!response.ok) {
                    throw new Error(response.status === 404 ? 'Город не найден' : `Ошибка: ${response.status}`);
                }
                return response.json();
            }

            function handleFetchError(error) {
                console.error('Fetch error:', error);
                hideError();
                currentWeatherDiv.innerHTML = `
                    <div class="loading">
                        <span class="material-symbols-outlined" style="font-size: 48px; color: var(--warning);">error</span>
                        ${error.message || 'Произошла ошибка при загрузке данных'}
                    </div>
                `;
            }

            function fetchAirQuality(lat, lon) {
                fetch(`https://api.openweathermap.org/data/2.5/air_pollution?lat=${lat}&lon=${lon}&appid=${apiKey}`)
                    .then(r => r.json())
                    .then(displayAirQuality)
                    .catch(console.error);
            }

            function fetchHourlyForecast(lat, lon) {
                fetch(`https://api.openweathermap.org/data/2.5/forecast?lat=${lat}&lon=${lon}&units=${currentUnit}&appid=${apiKey}&lang=ru`)
                    .then(r => r.json())
                    .then(data => displayHourlyForecast(data, selectedForecastDay))
                    .catch(console.error);
            }

            function displayCurrentWeather(data) {
                const weather = data.weather[0];
                const iconUrl = `https://openweathermap.org/img/wn/${weather.icon}@4x.png`;
                const date = new Date(data.dt * 1000);
                const options = {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                };
                const dateString = date.toLocaleDateString('ru-RU', options);
                const isFavorite = favorites.some(fav => fav.name === data.name && fav.country === data.sys.country);

                applyWeatherEffects(weather.main, weather.description);

                currentWeatherDiv.innerHTML = `
                            <div class="location-info">
                                <div class="location">
                                    <span class="material-symbols-outlined">location_on</span>
                                    ${data.name}, ${data.sys.country}
                                </div>
                                <button class="favorite-btn ${isFavorite ? 'active' : ''}" id="favorite-btn">
                                    <span class="material-symbols-outlined">${isFavorite ? 'favorite' : 'favorite_border'}</span>
                                </button>
                            </div>
                            <div class="date-time">${dateString}</div>
                            <div class="weather-main">
                                <div class="weather-icon-container">
                                    <div class="weather-icon-bg"></div>
                                    <img src="${iconUrl}" alt="${weather.description}" class="weather-icon">
                                </div>
                                <div class="temperature-container">
                                    <div class="temperature">${Math.round(data.main.temp)}<span class="temperature-unit">${currentUnit === 'metric' ? '°C' : '°F'}</span></div>
                                    <div class="description">${weather.description}</div>
                                </div>
                            </div>
                            <div class="details">
                                <div class="detail-item">
                                    <div class="detail-icon"><span class="material-symbols-outlined">device_thermostat</span></div>
                                    <div class="detail-value">${Math.round(data.main.feels_like)}${currentUnit === 'metric' ? '°C' : '°F'}</div>
                                    <div class="detail-label">Ощущается как</div>
                                </div>
                                <div class="detail-item">
                                    <div class="detail-icon"><span class="material-symbols-outlined">humidity_percentage</span></div>
                                    <div class="detail-value">${data.main.humidity}%</div>
                                    <div class="detail-label">Влажность</div>
                                </div>
                                <div class="detail-item">
                                    <div class="detail-icon"><span class="material-symbols-outlined">air</span></div>
                                    <div class="detail-value">${Math.round(data.wind.speed)} ${currentUnit === 'metric' ? 'м/с' : 'миль/ч'}</div>
                                    <div class="detail-label">Ветер</div>
                                </div>
                            </div>
                        `;

                const favoriteBtn = document.getElementById('favorite-btn');
                if (favoriteBtn) {
                    favoriteBtn.addEventListener('click', () => {
                        toggleFavorite(data.name, data.sys.country, data.coord.lat, data.coord.lon);
                    });
                }

                additionalInfoDiv.innerHTML = `
                            <div class="info-card">
                                <div class="info-card-title"><span class="material-symbols-outlined">visibility</span>Видимость</div>
                                <div class="info-card-value">${(data.visibility / 1000).toFixed(1)} км</div>
                            </div>
                            <div class="info-card">
                                <div class="info-card-title"><span class="material-symbols-outlined">speed</span>Давление</div>
                                <div class="info-card-value">${data.main.pressure} гПа</div>
                            </div>
                            <div class="info-card">
                                <div class="info-card-title"><span class="material-symbols-outlined">cloud</span>Облачность</div>
                                <div class="info-card-value">${data.clouds.all}%</div>
                            </div>
                            <div class="info-card">
                                <div class="info-card-title"><span class="material-symbols-outlined">wb_twilight</span>Восход и закат</div>
                                <div class="sun-times">
                                    <div class="sun-time">
                                        <div class="sun-icon sunrise-icon"><span class="material-symbols-outlined">clear_day</span></div>
                                        <div class="sun-time-value">${new Date(data.sys.sunrise * 1000).toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' })}</div>
                                        <div class="sun-time-label">Восход</div>
                                    </div>
                                    <div class="sun-time">
                                        <div class="sun-icon sunset-icon"><span class="material-symbols-outlined">clear_night</span></div>
                                        <div class="sun-time-value">${new Date(data.sys.sunset * 1000).toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' })}</div>
                                        <div class="sun-time-label">Закат</div>
                                    </div>
                                </div>
                            </div>
                        `;
            }

            function displayAirQuality(data) {
                const aqi = data.list[0] && data.list[0].main ? data.list[0].main.aqi || 0 : 0;
                const comp = data.list[0] && data.list[0].components ? data.list[0].components : {};
                let level = '',
                    cls = '',
                    desc = '';

                if (aqi >= 1 && aqi <= 5) {
                    const levels = {
                        1: {
                            l: 'Хорошо',
                            c: 'air-quality-good',
                            d: 'Качество воздуха удовлетворительное.'
                        },
                        2: {
                            l: 'Умеренно',
                            c: 'air-quality-moderate',
                            d: 'Некоторые загрязнители могут представлять умеренную угрозу.'
                        },
                        3: {
                            l: 'Нездорово',
                            c: 'air-quality-unhealthy',
                            d: 'Члены чувствительных групп могут испытывать проблемы.'
                        },
                        4: {
                            l: 'Очень нездорово',
                            c: 'air-quality-very-unhealthy',
                            d: 'Возможны серьёзные последствия для здоровья.'
                        },
                        5: {
                            l: 'Опасно',
                            c: 'air-quality-hazardous',
                            d: 'Чрезвычайная ситуация — все могут пострадать.'
                        }
                    }[aqi];

                    if (levels) {
                        level = levels.l;
                        cls = levels.c;
                        desc = levels.d;
                    }
                } else {
                    level = 'Недоступно';
                }

                airQualityDiv.innerHTML = `
                        <h3 class="section-title"><span class="material-symbols-outlined">airwave</span>Качество воздуха</h3>
                        <div class="air-quality-index">
                            Индекс AQI: ${aqi || '?'}
                            <span class="air-quality-level ${cls}">${level}</span>
                        </div>
                        <p>${desc}</p>
                        <div class="air-quality-details">
                            <div class="air-quality-item"><span>CO:</span> ${comp.co ? comp.co.toFixed(1) : '—'} µg/m³</div>
                            <div class="air-quality-item"><span>NO₂:</span> ${comp.no2 ? comp.no2.toFixed(1) : '—'} µg/m³</div>
                            <div class="air-quality-item"><span>O₃:</span> ${comp.o3 ? comp.o3.toFixed(1) : '—'} µg/m³</div>
                            <div class="air-quality-item"><span>SO₂:</span> ${comp.so2 ? comp.so2.toFixed(1) : '—'} µg/m³</div>
                            <div class="air-quality-item"><span>PM2.5:</span> ${comp.pm2_5 ? comp.pm2_5.toFixed(1) : '—'} µg/m³</div>
                            <div class="air-quality-item"><span>PM10:</span> ${comp.pm10 ? comp.pm10.toFixed(1) : '—'} µg/m³</div>
                        </div>
                    `;
                airQualityDiv.style.display = 'block';
            }

            function displayHourlyForecast(data, dayIndex = 0) {
                const targetDate = new Date();
                targetDate.setDate(targetDate.getDate() + dayIndex);
                const targetDayString = formatDateKey(targetDate);

                const hourlyData = data.list
                    .filter(item => {
                        const itemDate = new Date(item.dt * 1000);
                        return formatDateKey(itemDate) === targetDayString;
                    })
                    .slice(0, 8);

                hourlyItemsDiv.innerHTML = hourlyData.map(item => {
                    const time = new Date(item.dt * 1000).toLocaleTimeString('ru-RU', {
                        hour: '2-digit'
                    });
                    const icon = `https://openweathermap.org/img/wn/${item.weather[0].icon}.png`;
                    const temp = Math.round(item.main.temp);
                    return `
                        <div class="hourly-item">
                            <div class="hourly-time">${time}</div>
                            <img src="${icon}" alt="${item.weather[0].description}" class="hourly-icon">
                            <div class="hourly-temp">${temp}${currentUnit === 'metric' ? '°C' : '°F'}</div>
                        </div>
                    `;
                }).join('');

                hourlyForecastDiv.style.display = 'block';
            }

            function displayForecast(data) {
                const groups = {};
                data.list.forEach(item => {
                    const dayKey = formatDateKey(new Date(item.dt * 1000));
                    if (!groups[dayKey]) groups[dayKey] = [];
                    groups[dayKey].push(item);
                });

                const dailyList = Object.keys(groups)
                    .map(day => {
                        const list = groups[day];
                        return list.reduce((best, item) => {
                            const hour = new Date(item.dt * 1000).getHours();
                            const dist1 = Math.abs(hour - 12);
                            const dist2 = Math.abs(new Date(best.dt * 1000).getHours() - 12);
                            return dist1 < dist2 ? item : best;
                        });
                    })
                    .slice(0, 5);

                forecastItemsDiv.innerHTML = dailyList.map((item, i) => {
                    const d = new Date(item.dt * 1000);
                    const dayNames = ['Вс', 'Пн', 'Вт', 'Ср', 'Чт', 'Пт', 'Сб'];
                    return `
                        <div class="forecast-item ${i === selectedForecastDay ? 'active' : ''}" data-index="${i}">
                            <div class="forecast-day">${dayNames[d.getDay()]}</div>
                            <div class="forecast-date">${d.toLocaleDateString('ru-RU', { day: 'numeric', month: 'short' })}</div>
                            <img src="https://openweathermap.org/img/wn/${item.weather[0].icon}.png" class="forecast-icon" alt="${item.weather[0].description}">
                            <div class="forecast-temp">
                                <span class="forecast-temp-max">${Math.round(item.main.temp_max)}${currentUnit === 'metric' ? '°C' : '°F'}</span>
                                <span>${Math.round(item.main.temp_min)}${currentUnit === 'metric' ? '°C' : '°F'}</span>
                            </div>
                        </div>
                    `;
                }).join('');

                document.querySelectorAll('.forecast-item').forEach(el => {
                    el.addEventListener('click', e => {
                        document.querySelectorAll('.forecast-item').forEach(i => i.classList.remove('active'));
                        e.currentTarget.classList.add('active');
                        selectedForecastDay = parseInt(e.currentTarget.dataset.index);
                        displayHourlyForecast(data, selectedForecastDay);
                    });
                });

                displayHourlyForecast(data, selectedForecastDay);
            }

            function formatDateKey(date) {
                const d = new Date(date);
                return `${d.getFullYear()}-${(d.getMonth() + 1).toString().padStart(2, '0')}-${d.getDate().toString().padStart(2, '0')}`;
            }

            function initMap(lat, lon, name = 'Текущее местоположение') {
                mapContainerDiv.style.display = 'block';
                if (!mapInitialized) {
                    map = L.map('map').setView([lat, lon], 12);
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                    }).addTo(map);
                    marker = L.marker([lat, lon]).addTo(map)
                        .bindPopup(`<b>${name}</b><br>Широта: ${lat.toFixed(4)}, Долгота: ${lon.toFixed(4)}`)
                        .openPopup();
                    mapInitialized = true;
                } else {
                    map.setView([lat, lon], 12);
                    marker.setLatLng([lat, lon])
                        .setPopupContent(`<b>${name}</b><br>Широта: ${lat.toFixed(4)}, Долгота: ${lon.toFixed(4)}`)
                        .openPopup();
                }
            }

            function toggleFavorite(name, country, lat, lon) {
                const btn = document.getElementById('favorite-btn');
                const idx = favorites.findIndex(f => f.name === name && f.country === country);
                if (idx === -1) {
                    favorites.push({
                        name,
                        country,
                        lat,
                        lon
                    });
                    if (btn) {
                        btn.innerHTML = '<span class="material-symbols-outlined">favorite</span>';
                        btn.classList.add('active');
                    }
                } else {
                    favorites.splice(idx, 1);
                    if (btn) {
                        btn.innerHTML = '<span class="material-symbols-outlined">favorite_border</span>';
                        btn.classList.remove('active');
                    }
                }
                localStorage.setItem('weatherFavorites', JSON.stringify(favorites));
                updateFavoritesList();
            }

            function updateFavoritesList() {
                if (favorites.length === 0) {
                    favoritesListDiv.innerHTML = `
                        <div style="text-align:center;padding:20px;color:#aaa;">
                            <span class="material-symbols-outlined" style="font-size:48px;">favorite</span>
                            <p>Нет избранных городов</p>
                        </div>
                    `;
                    return;
                }

                favoritesListDiv.innerHTML = '<div class="loading"><div class="loading-spinner"></div>Обновление данных...</div>';

                Promise.allSettled(
                    favorites.map(f =>
                        fetch(`https://api.openweathermap.org/data/2.5/weather?lat=${f.lat}&lon=${f.lon}&units=${currentUnit}&appid=${apiKey}&lang=ru`)
                        .then(r => r.json())
                        .catch(() => null)
                    )
                ).then(results => {
                    const valid = results
                        .filter(r => r.status === 'fulfilled' && r.value)
                        .map(r => r.value);

                    if (valid.length === 0) {
                        favoritesListDiv.innerHTML = `<div style="text-align:center;padding:20px;color:#aaa;">
                            <span class="material-symbols-outlined" style="font-size:48px;">error</span>
                            <p>Не удалось загрузить избранные города</p>
                        </div>`;
                        return;
                    }

                    favoritesListDiv.innerHTML = valid.map(city => {
                        const icon = `https://openweathermap.org/img/wn/${city.weather[0].icon}.png`;
                        const time = new Date(city.dt * 1000).toLocaleTimeString('ru-RU', {
                            hour: '2-digit',
                            minute: '2-digit'
                        });
                        return `
                            <div class="favorite-city" data-name="${city.name}" data-country="${city.sys.country}">
                                <div class="favorite-city-info">
                                    <div class="favorite-city-name">${city.name}, ${city.sys.country}</div>
                                    <div class="favorite-city-time">${time}</div>
                                </div>
                                <div class="favorite-city-weather">
                                    <div class="favorite-city-temp">${Math.round(city.main.temp)}${currentUnit === 'metric' ? '°C' : '°F'}</div>
                                    <img src="${icon}" class="favorite-city-icon" alt="${city.weather[0].description}">
                                    <button class="remove-btn" data-name="${city.name}" data-country="${city.sys.country}">
                                        <span class="material-symbols-outlined">close</span>
                                    </button>
                                </div>
                            </div>
                        `;
                    }).join('');

                    document.querySelectorAll('.favorite-city').forEach(el => {
                        el.addEventListener('click', e => {
                            if (!e.target.closest('.remove-btn')) {
                                fetchWeather(`${el.dataset.name},${el.dataset.country}`);
                                document.querySelector('.tab[data-tab="current"]').click();
                            }
                        });
                    });

                    document.querySelectorAll('.remove-btn').forEach(btn => {
                        btn.addEventListener('click', e => {
                            e.stopPropagation();
                            const {
                                name,
                                country
                            } = btn.dataset;
                            favorites = favorites.filter(f => !(f.name === name && f.country === country));
                            localStorage.setItem('weatherFavorites', JSON.stringify(favorites));
                            updateFavoritesList();
                            if (currentLocation === name) {
                                const favBtn = document.getElementById('favorite-btn');
                                if (favBtn) {
                                    favBtn.classList.remove('active');
                                    favBtn.innerHTML = '<span class="material-symbols-outlined">favorite_border</span>';
                                }
                            }
                        });
                    });
                });
            }

            function updateFavoritesWeather() {
                if (favorites.length > 0) updateFavoritesList();
            }

            function applyWeatherEffects(main, desc) {
                const classes = ['animate-rain', 'animate-snow', 'animate-clouds', 'animate-sun', 'animate-thunder'];
                classes.forEach(cls => weatherContainer.classList.remove(cls));

                let bg = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                let anim = '';

                const weather = String(main).toLowerCase();
                if (weather === 'thunderstorm') {
                    bg = 'linear-gradient(135deg, #0f2027 0%, #203a43 50%, #2c5364 100%)';
                    anim = 'animate-thunder';
                } else if (['drizzle', 'rain'].includes(weather)) {
                    bg = 'linear-gradient(135deg, #3a7bd5 0%, #00d2ff 100%)';
                    anim = 'animate-rain';
                } else if (weather === 'snow') {
                    bg = 'linear-gradient(135deg, #e6dada 0%, #274046 100%)';
                    anim = 'animate-snow';
                } else if (weather === 'clear') {
                    bg = desc.includes('ночь') || desc.includes('вечер') ?
                        'linear-gradient(135deg, #0f2027 0%, #203a43 50%, #2c5364 100%)' :
                        'linear-gradient(135deg, #ff7e5f 0%, #feb47b 100%)';
                    if (!desc.includes('ночь')) anim = 'animate-sun';
                } else if (weather === 'clouds') {
                    bg = desc.includes('пасмурно') ?
                        'linear-gradient(135deg, #606c88 0%, #3f4c6b 100%)' :
                        'linear-gradient(135deg, #bdc3c7 0%, #2c3e50 100%)';
                    anim = 'animate-clouds';
                } else if (['mist', 'smoke', 'haze', 'dust', 'fog', 'sand', 'ash'].includes(weather)) {
                    bg = 'linear-gradient(135deg, #BDC3C7 0%, #2C3E50 100%)';
                    anim = 'animate-clouds';
                } else if (['squall', 'tornado'].includes(weather)) {
                    bg = 'linear-gradient(135deg, #1F1C2C 0%, #928DAB 100%)';
                }

                body.style.background = bg;
                if (anim) weatherContainer.classList.add(anim);
            }

            function showLoading(message = 'Загрузка...') {
                currentWeatherDiv.innerHTML = `
                    <div class="loading">
                        <div class="loading-spinner"></div>
                        ${message}
                    </div>
                `;
                forecastItemsDiv.innerHTML = '';
                hourlyItemsDiv.innerHTML = '';
                additionalInfoDiv.innerHTML = '';
                airQualityDiv.style.display = 'none';
                hourlyForecastDiv.style.display = 'none';
                mapContainerDiv.style.display = 'none';
            }

            function resetSections() {
                forecastItemsDiv.innerHTML = '';
                hourlyItemsDiv.innerHTML = '';
                additionalInfoDiv.innerHTML = '';
                airQualityDiv.style.display = 'none';
                hourlyForecastDiv.style.display = 'none';
                mapContainerDiv.style.display = 'none';
            }

            function showError(message) {
                errorMessageDiv.textContent = message;
                setTimeout(hideError, 5000);
            }

            function hideError() {
                errorMessageDiv.textContent = '';
            }
        });
    </script>
</body>

</html>
